<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzplaner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .minimal-input {
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .minimal-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .minimal-button {
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .minimal-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-light text-gray-900 mb-3 tracking-tight">Finanzplaner</h1>
            <p class="text-gray-500 font-light">Minimalistisch. Übersichtlich. Effektiv.</p>
        </div>

        <!-- GitHub Backend Integration Status -->
        <div id="backendStatus" class="mb-8 p-4 glass-card rounded-xl">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center space-x-3">
                    <span class="text-gray-600 text-sm font-light">🔄 GitHub Backend</span>
                    <span id="syncStatus" class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Aktiv</span>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-600">💾 Automatische Speicherung in data.json</span>
                    <button onclick="exportToExcel()" 
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg minimal-button">
                        Excel Export
                    </button>
                    <button onclick="manualSync()" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg minimal-button">
                        Sync Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="glass-card rounded-2xl p-8 text-center">
                <h3 class="text-sm font-medium text-gray-500 mb-3 uppercase tracking-wide">Einnahmen</h3>
                <p id="totalIncome" class="text-3xl font-light text-gray-900">0,00 €</p>
            </div>
            <div class="glass-card rounded-2xl p-8 text-center">
                <h3 class="text-sm font-medium text-gray-500 mb-3 uppercase tracking-wide">Fixkosten</h3>
                <p id="totalMonthly" class="text-3xl font-light text-gray-900">0,00 €</p>
            </div>
            <div class="glass-card rounded-2xl p-8 text-center">
                <h3 class="text-sm font-medium text-gray-500 mb-3 uppercase tracking-wide">Verfügbar</h3>
                <p id="available" class="text-3xl font-light text-indigo-600">0,00 €</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            
            <!-- Einnahmen Section -->
            <div class="glass-card rounded-2xl p-8">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Einnahmen</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Haupteinkommen</label>
                        <input type="number" id="mainIncome" placeholder="0,00" 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Nebeneinkommen</label>
                        <input type="number" id="sideIncome" placeholder="0,00" 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <button onclick="updateIncome()" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-6 rounded-xl minimal-button">
                        Aktualisieren
                    </button>
                </div>
            </div>

            <!-- Monatliche Kosten Section -->
            <div class="glass-card rounded-2xl p-8">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Fixkosten</h2>
                
                <div class="space-y-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Bezeichnung</label>
                        <input type="text" id="costName" placeholder="Miete, Strom, Internet..." 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Betrag</label>
                        <input type="number" id="costAmount" placeholder="0,00" 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <button onclick="addMonthlyCost()" 
                            class="w-full bg-gray-900 hover:bg-gray-800 text-white py-3 px-6 rounded-xl minimal-button">
                        Hinzufügen
                    </button>
                </div>
                
                <div id="monthlyCostsList" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Monthly costs will be added here -->
                </div>
            </div>

            <!-- Wöchentliche Ausgaben Section -->
            <div class="glass-card rounded-2xl p-8 lg:col-span-2 xl:col-span-1">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Variable Ausgaben</h2>
                
                <div class="space-y-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Beschreibung</label>
                        <input type="text" id="purchaseName" placeholder="Lebensmittel, Tankstelle..." 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Betrag</label>
                        <input type="number" id="purchaseAmount" placeholder="0,00" 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <button onclick="addPurchase()" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-6 rounded-xl minimal-button">
                        Ausgabe erfassen
                    </button>
                </div>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Gesamt diese Woche</span>
                        <span id="weeklyTotal" class="text-lg font-medium text-gray-900">0,00 €</span>
                    </div>
                </div>
                
                <div id="purchasesList" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Purchases will be added here -->
                </div>
            </div>
        </div>

        <!-- Monthly Report Section -->
        <div class="mt-12 glass-card rounded-2xl p-8">
            <h2 class="text-lg font-medium text-gray-900 mb-6">Monatsübersicht</h2>
            
            <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <button onclick="generateMonthlyReport()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-6 rounded-xl minimal-button">
                    Bericht erstellen
                </button>
                <span class="text-sm text-gray-500 font-light">Automatisch am 24. jeden Monats</span>
            </div>
            
            <div id="monthlyReport" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monat</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Einnahmen</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fixkosten</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variable</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="divide-y divide-gray-100">
                            <!-- Report data will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let financialData = {
            mainIncome: 0,
            sideIncome: 0,
            monthlyCosts: [],
            weeklyPurchases: [],
            monthlyReports: []
        };

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('financialData');
            if (saved) {
                financialData = JSON.parse(saved);
                updateDisplay();
            }
        }

        // Save data to localStorage and GitHub
        function saveData() {
            localStorage.setItem('financialData', JSON.stringify(financialData));
            // Automatische GitHub Synchronisation
            saveToGitHub();
        }

        // GitHub Backend Integration - Konfiguration
        const GITHUB_CONFIG = {
            owner: 'CptKiffKopf',                 // GitHub Username aus dem Link
            repo: 'xsd42-42445-231',              // Repository Name aus dem Link
            token: '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', // Dein Personal Access Token
            dataFile: 'data/finanzplaner.json'   // Pfad zur Datendatei im Repository
        };

        // WICHTIG: Token Berechtigung für 401 Fehler
        // Für ÖFFENTLICHE GitHub Pages Projekte brauchst du:
        // ✅ "public_repo" - Access public repositories
        // 
        // So erstellst du einen neuen Token:
        // 1. GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
        // 2. Generate new token (classic)
        // 3. Wähle "public_repo" Berechtigung aus (NICHT "repo"!)
        // 4. Token kopieren und oben einfügen

        let backendConnected = true;

        // GitHub API Funktionen
        async function saveToGitHub() {
            if (!backendConnected || !isGitHubConfigured()) {
                console.log('GitHub Backend nicht konfiguriert');
                return;
            }

            try {
                // Prüfe zuerst ob Repository existiert
                const repoResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                    }
                });

                if (!repoResponse.ok) {
                    throw new Error(`Repository nicht gefunden oder kein Zugriff. Status: ${repoResponse.status}`);
                }

                // Erstelle data/ Ordner falls nicht vorhanden
                await ensureDataDirectory();
                
                // Aktuelle Datei von GitHub laden um SHA zu bekommen
                const currentFile = await getFileFromGitHub();
                
                // Daten als JSON formatieren
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(financialData, null, 2))));
                
                // Datei auf GitHub aktualisieren
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Finanzplaner Update - ${new Date().toISOString()}`,
                        content: content,
                        sha: currentFile ? currentFile.sha : undefined
                    })
                });

                if (response.ok) {
                    showNotification('Daten erfolgreich zu GitHub gespeichert! 💾');
                    updateSyncStatus('success');
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub API Fehler: ${response.status} - ${errorData.message || 'Unbekannter Fehler'}`);
                }
            } catch (error) {
                console.error('GitHub Sync Fehler:', error);
                showNotification(`GitHub Fehler: ${error.message} ⚠️`);
                updateSyncStatus('error');
            }
        }

        // Stelle sicher, dass data/ Ordner existiert
        async function ensureDataDirectory() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                    }
                });
                
                if (response.status === 404) {
                    // Erstelle data/ Ordner mit einer .gitkeep Datei
                    await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data/.gitkeep`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: 'Erstelle data/ Ordner für Finanzplaner',
                            content: btoa('# Finanzplaner Daten\n')
                        })
                    });
                }
            } catch (error) {
                console.log('Ordner-Erstellung übersprungen:', error.message);
            }
        }

        async function loadFromGitHub() {
            if (!isGitHubConfigured()) {
                console.log('GitHub Backend nicht konfiguriert');
                return;
            }

            try {
                const fileData = await getFileFromGitHub();
                if (fileData && fileData.content) {
                    const decodedContent = decodeURIComponent(escape(atob(fileData.content)));
                    const loadedData = JSON.parse(decodedContent);
                    
                    // Merge mit lokalen Daten (lokale Daten haben Priorität)
                    const localDataExists = localStorage.getItem('financialData');
                    if (!localDataExists) {
                        financialData = loadedData;
                        updateDisplay();
                        showNotification('Daten von GitHub geladen! 📥');
                    }
                }
            } catch (error) {
                console.error('GitHub Load Fehler:', error);
                showNotification('Fehler beim Laden von GitHub! ⚠️');
            }
        }

        async function getFileFromGitHub() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                } else if (response.status === 404) {
                    // Datei existiert noch nicht
                    return null;
                } else {
                    throw new Error('GitHub API Fehler');
                }
            } catch (error) {
                console.error('GitHub Get File Fehler:', error);
                return null;
            }
        }

        function isGitHubConfigured() {
            return GITHUB_CONFIG.owner !== 'dein-username' && 
                   GITHUB_CONFIG.repo !== 'finanzplaner' && 
                   GITHUB_CONFIG.token !== 'ghp_xxxxxxxxxxxx';
        }

        function updateSyncStatus(status) {
            const statusElement = document.getElementById('syncStatus');
            switch(status) {
                case 'success':
                    statusElement.textContent = 'Synchronisiert';
                    statusElement.className = 'px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full';
                    break;
                case 'error':
                    statusElement.textContent = 'Fehler';
                    statusElement.className = 'px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full';
                    break;
                case 'syncing':
                    statusElement.textContent = 'Synchronisiert...';
                    statusElement.className = 'px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full';
                    break;
                default:
                    statusElement.textContent = 'Bereit';
                    statusElement.className = 'px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full';
            }
        }

        // Manuelle Synchronisation
        async function manualSync() {
            updateSyncStatus('syncing');
            await saveToGitHub();
        }

        // GitHub Backend initialisieren
        async function initializeGitHubBackend() {
            if (isGitHubConfigured()) {
                updateSyncStatus('syncing');
                await loadFromGitHub();
                updateSyncStatus('success');
                showNotification('GitHub Backend erfolgreich verbunden! 🔄');
            } else {
                updateSyncStatus('error');
                showNotification('GitHub Backend nicht konfiguriert! Bitte Zugangsdaten im Code hinterlegen. ⚠️');
            }
        }

        // Excel Export Function
        function exportToExcel() {
            const data = prepareExportData();
            const csvContent = convertToCSV(data);
            downloadCSV(csvContent, `Finanzplaner_${new Date().toISOString().slice(0, 10)}.csv`);
            showNotification('Excel-Datei wurde heruntergeladen! 📁');
        }

        function prepareExportData() {
            const exportData = [];
            
            // Header
            exportData.push(['Finanzplaner Export - ' + new Date().toLocaleDateString('de-DE')]);
            exportData.push([]);
            
            // Einnahmen
            exportData.push(['EINNAHMEN']);
            exportData.push(['Haupteinkommen', formatCurrency(financialData.mainIncome)]);
            exportData.push(['Nebeneinkommen', formatCurrency(financialData.sideIncome)]);
            exportData.push(['Gesamt Einnahmen', formatCurrency(financialData.mainIncome + financialData.sideIncome)]);
            exportData.push([]);
            
            // Fixkosten
            exportData.push(['FIXKOSTEN']);
            financialData.monthlyCosts.forEach(cost => {
                exportData.push([cost.name, formatCurrency(cost.amount), formatDate(cost.date)]);
            });
            exportData.push(['Gesamt Fixkosten', formatCurrency(financialData.monthlyCosts.reduce((sum, cost) => sum + cost.amount, 0))]);
            exportData.push([]);
            
            // Variable Ausgaben
            exportData.push(['VARIABLE AUSGABEN']);
            financialData.weeklyPurchases.forEach(purchase => {
                exportData.push([purchase.name, formatCurrency(purchase.amount), formatDate(purchase.date)]);
            });
            exportData.push(['Gesamt Variable', formatCurrency(financialData.weeklyPurchases.reduce((sum, purchase) => sum + purchase.amount, 0))]);
            exportData.push([]);
            
            // Monatsberichte
            if (financialData.monthlyReports.length > 0) {
                exportData.push(['MONATSBERICHTE']);
                exportData.push(['Monat', 'Einnahmen', 'Fixkosten', 'Variable Ausgaben', 'Saldo']);
                financialData.monthlyReports.forEach(report => {
                    exportData.push([
                        formatMonth(report.month),
                        formatCurrency(report.income),
                        formatCurrency(report.fixedCosts),
                        formatCurrency(report.variableExpenses),
                        formatCurrency(report.balance)
                    ]);
                });
            }
            
            return exportData;
        }

        function convertToCSV(data) {
            return data.map(row => 
                row.map(cell => 
                    typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell
                ).join(',')
            ).join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Update income
        function updateIncome() {
            const mainIncome = parseFloat(document.getElementById('mainIncome').value) || 0;
            const sideIncome = parseFloat(document.getElementById('sideIncome').value) || 0;
            
            financialData.mainIncome = mainIncome;
            financialData.sideIncome = sideIncome;
            
            updateDisplay();
            saveData();
            showNotification('Einnahmen aktualisiert! 💰');
        }

        // Add monthly cost
        function addMonthlyCost() {
            const name = document.getElementById('costName').value.trim();
            const amount = parseFloat(document.getElementById('costAmount').value) || 0;
            
            if (name && amount > 0) {
                financialData.monthlyCosts.push({
                    id: Date.now(),
                    name: name,
                    amount: amount,
                    date: new Date().toISOString()
                });
                
                document.getElementById('costName').value = '';
                document.getElementById('costAmount').value = '';
                
                updateDisplay();
                saveData();
                showNotification('Monatliche Kosten hinzugefügt! 📋');
            }
        }

        // Remove monthly cost
        function removeMonthlyCost(id) {
            financialData.monthlyCosts = financialData.monthlyCosts.filter(cost => cost.id !== id);
            updateDisplay();
            saveData();
            showNotification('Kosten entfernt! 🗑️');
        }

        // Add purchase
        function addPurchase() {
            const name = document.getElementById('purchaseName').value.trim();
            const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
            
            if (name && amount > 0) {
                financialData.weeklyPurchases.push({
                    id: Date.now(),
                    name: name,
                    amount: amount,
                    date: new Date().toISOString()
                });
                
                document.getElementById('purchaseName').value = '';
                document.getElementById('purchaseAmount').value = '';
                
                updateDisplay();
                saveData();
                showNotification('Einkauf hinzugefügt! 🛒');
            }
        }

        // Remove purchase
        function removePurchase(id) {
            financialData.weeklyPurchases = financialData.weeklyPurchases.filter(purchase => purchase.id !== id);
            updateDisplay();
            saveData();
            showNotification('Einkauf entfernt! 🗑️');
        }

        // Update display
        function updateDisplay() {
            // Update summary
            const totalIncome = financialData.mainIncome + financialData.sideIncome;
            const totalMonthly = financialData.monthlyCosts.reduce((sum, cost) => sum + cost.amount, 0);
            const available = totalIncome - totalMonthly;
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalMonthly').textContent = formatCurrency(totalMonthly);
            document.getElementById('available').textContent = formatCurrency(available);
            
            // Update input fields
            document.getElementById('mainIncome').value = financialData.mainIncome || '';
            document.getElementById('sideIncome').value = financialData.sideIncome || '';
            
            // Update monthly costs list
            const monthlyCostsList = document.getElementById('monthlyCostsList');
            monthlyCostsList.innerHTML = '';
            financialData.monthlyCosts.forEach(cost => {
                const costElement = document.createElement('div');
                costElement.className = 'flex justify-between items-center p-4 bg-white rounded-xl border border-gray-100 fade-in';
                costElement.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-900">${cost.name}</span>
                        <span class="text-sm text-gray-500 block">${formatCurrency(cost.amount)}</span>
                    </div>
                    <button onclick="removeMonthlyCost(${cost.id})" 
                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">×</button>
                `;
                monthlyCostsList.appendChild(costElement);
            });
            
            // Update purchases list
            const weeklyTotal = financialData.weeklyPurchases.reduce((sum, purchase) => sum + purchase.amount, 0);
            document.getElementById('weeklyTotal').textContent = formatCurrency(weeklyTotal);
            
            const purchasesList = document.getElementById('purchasesList');
            purchasesList.innerHTML = '';
            financialData.weeklyPurchases.forEach(purchase => {
                const purchaseElement = document.createElement('div');
                purchaseElement.className = 'flex justify-between items-center p-4 bg-white rounded-xl border border-gray-100 fade-in';
                purchaseElement.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-900">${purchase.name}</span>
                        <span class="text-sm text-gray-500 block">${formatCurrency(purchase.amount)} • ${formatDate(purchase.date)}</span>
                    </div>
                    <button onclick="removePurchase(${purchase.id})" 
                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">×</button>
                `;
                purchasesList.appendChild(purchaseElement);
            });
        }

        // Generate monthly report
        function generateMonthlyReport() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const totalIncome = financialData.mainIncome + financialData.sideIncome;
            const totalMonthly = financialData.monthlyCosts.reduce((sum, cost) => sum + cost.amount, 0);
            const totalWeekly = financialData.weeklyPurchases.reduce((sum, purchase) => sum + purchase.amount, 0);
            const saldo = totalIncome - totalMonthly - totalWeekly;
            
            const report = {
                month: currentMonth,
                income: totalIncome,
                fixedCosts: totalMonthly,
                variableExpenses: totalWeekly,
                balance: saldo,
                date: new Date().toISOString(),
                fixedCostsList: [...financialData.monthlyCosts] // Fixkosten für nächsten Monat speichern
            };
            
            // Add to reports if not already exists for this month
            const existingIndex = financialData.monthlyReports.findIndex(r => r.month === currentMonth);
            if (existingIndex >= 0) {
                financialData.monthlyReports[existingIndex] = report;
            } else {
                financialData.monthlyReports.push(report);
            }
            
            // Clear only weekly purchases for new month - Fixkosten bleiben bestehen!
            financialData.weeklyPurchases = [];
            
            updateDisplay();
            displayMonthlyReport();
            saveData();
            showNotification('Monatsbericht erstellt! Fixkosten wurden für nächsten Monat übernommen 📊');
        }

        // Display monthly report
        function displayMonthlyReport() {
            const reportSection = document.getElementById('monthlyReport');
            const tableBody = document.getElementById('reportTableBody');
            
            tableBody.innerHTML = '';
            financialData.monthlyReports.forEach(report => {
                const row = document.createElement('tr');
                row.className = 'fade-in';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatMonth(report.month)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(report.income)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(report.fixedCosts)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(report.variableExpenses)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${report.balance >= 0 ? 'text-indigo-600' : 'text-red-500'}">${formatCurrency(report.balance)}</td>
                `;
                tableBody.appendChild(row);
            });
            
            reportSection.classList.remove('hidden');
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('de-DE');
        }

        function formatMonth(monthString) {
            const date = new Date(monthString + '-01');
            return date.toLocaleDateString('de-DE', { year: 'numeric', month: 'long' });
        }

        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-6 right-6 bg-white border border-gray-200 text-gray-900 px-6 py-4 rounded-2xl shadow-lg z-50 fade-in';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-indigo-500 rounded-full"></div>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
                setTimeout(() => notification.remove(), 200);
            }, 3000);
        }

        // Auto-sync on 24th of month (simulation)
        function checkAutoSync() {
            const today = new Date();
            if (today.getDate() === 24) {
                generateMonthlyReport();
            }
        }

        // Event listeners for Enter key
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // GitHub Backend beim Laden initialisieren
            initializeGitHubBackend();
            
            // Add enter key listeners
            document.getElementById('costName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addMonthlyCost();
            });
            
            document.getElementById('costAmount').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addMonthlyCost();
            });
            
            document.getElementById('purchaseName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addPurchase();
            });
            
            document.getElementById('purchaseAmount').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addPurchase();
            });
            

            
            // Check for auto-sync daily
            setInterval(checkAutoSync, 24 * 60 * 60 * 1000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9749f91652433f0f',t:'MTc1NjExMzIwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
