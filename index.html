<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzplaner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .minimal-input {
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .minimal-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .minimal-button {
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .minimal-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-light text-gray-900 mb-3 tracking-tight">Finanzplaner</h1>
            <p class="text-gray-500 font-light">Minimalistisch. √úbersichtlich. Effektiv.</p>
        </div>

        <!-- Google Sheets Backend Status -->
        <div id="backendStatus" class="mb-8 p-4 glass-card rounded-xl">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center space-x-3">
                    <span class="text-gray-600 text-sm font-light">üìä Google Sheets Backend</span>
                    <span id="syncStatus" class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Verbunden</span>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-600">‚òÅÔ∏è Automatische Cloud-Speicherung</span>
                    <button onclick="exportToExcel()" 
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg minimal-button">
                        üìÅ Excel Export
                    </button>
                    <button onclick="manualSync()" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg minimal-button">
                        üîÑ Sync Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="glass-card rounded-2xl p-8 text-center">
                <h3 class="text-sm font-medium text-gray-500 mb-3 uppercase tracking-wide">Einnahmen</h3>
                <p id="totalIncome" class="text-3xl font-light text-gray-900">0,00 ‚Ç¨</p>
            </div>
            <div class="glass-card rounded-2xl p-8 text-center">
                <h3 class="text-sm font-medium text-gray-500 mb-3 uppercase tracking-wide">Fixkosten</h3>
                <p id="totalMonthly" class="text-3xl font-light text-gray-900">0,00 ‚Ç¨</p>
            </div>
            <div class="glass-card rounded-2xl p-8 text-center">
                <h3 class="text-sm font-medium text-gray-500 mb-3 uppercase tracking-wide">Verf√ºgbar</h3>
                <p id="available" class="text-3xl font-light text-indigo-600">0,00 ‚Ç¨</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            
            <!-- Einnahmen Section -->
            <div class="glass-card rounded-2xl p-8">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Einnahmen</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Haupteinkommen</label>
                        <input type="number" id="mainIncome" placeholder="0,00" 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Nebeneinkommen</label>
                        <input type="number" id="sideIncome" placeholder="0,00" 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <button onclick="updateIncome()" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-6 rounded-xl minimal-button">
                        Aktualisieren
                    </button>
                </div>
            </div>

            <!-- Monatliche Kosten Section -->
            <div class="glass-card rounded-2xl p-8">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Fixkosten</h2>
                
                <div class="space-y-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Bezeichnung</label>
                        <input type="text" id="costName" placeholder="Miete, Strom, Internet..." 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Betrag</label>
                        <input type="number" id="costAmount" placeholder="0,00" 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <button onclick="addMonthlyCost()" 
                            class="w-full bg-gray-900 hover:bg-gray-800 text-white py-3 px-6 rounded-xl minimal-button">
                        Hinzuf√ºgen
                    </button>
                </div>
                
                <div id="monthlyCostsList" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Monthly costs will be added here -->
                </div>
            </div>

            <!-- W√∂chentliche Ausgaben Section -->
            <div class="glass-card rounded-2xl p-8 lg:col-span-2 xl:col-span-1">
                <h2 class="text-lg font-medium text-gray-900 mb-6">Variable Ausgaben</h2>
                
                <div class="space-y-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Beschreibung</label>
                        <input type="text" id="purchaseName" placeholder="Lebensmittel, Tankstelle..." 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-3">Betrag</label>
                        <input type="number" id="purchaseAmount" placeholder="0,00" 
                               class="w-full px-4 py-3 minimal-input rounded-xl focus:outline-none bg-white">
                    </div>
                    
                    <button onclick="addPurchase()" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-6 rounded-xl minimal-button">
                        Ausgabe erfassen
                    </button>
                </div>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Gesamt diese Woche</span>
                        <span id="weeklyTotal" class="text-lg font-medium text-gray-900">0,00 ‚Ç¨</span>
                    </div>
                </div>
                
                <div id="purchasesList" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Purchases will be added here -->
                </div>
            </div>
        </div>

        <!-- Monthly Report Section -->
        <div class="mt-12 glass-card rounded-2xl p-8">
            <h2 class="text-lg font-medium text-gray-900 mb-6">Monats√ºbersicht</h2>
            
            <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <button onclick="generateMonthlyReport()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-6 rounded-xl minimal-button">
                    Bericht erstellen
                </button>
                <span class="text-sm text-gray-500 font-light">Automatisch am 24. jeden Monats</span>
            </div>
            
            <div id="monthlyReport" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monat</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Einnahmen</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fixkosten</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variable</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="divide-y divide-gray-100">
                            <!-- Report data will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Konfiguration mit OAuth2 Support
        const GOOGLE_SHEETS_CONFIG = {
            apiKey: 'AIzaSyBrXLr8H8zejdhlYGftrK0CjSnLEkLppog',  // F√ºr Lesezugriff
            clientId: '83678230925-8fhk59dafdkp92fcgjigov5hurigr1rp.apps.googleusercontent.com', // OAuth2 Client ID
            spreadsheetId: '13TyhKSNdlhapMvuG7rA1tVLQoZJUDfJusZBB4A-zAIs', // Deine Google Sheet ID
            range: 'Finanzplaner!A:Z',
            scopes: 'https://www.googleapis.com/auth/spreadsheets'
        };

        // Data storage
        let financialData = {
            mainIncome: 0,
            sideIncome: 0,
            monthlyCosts: [],
            weeklyPurchases: [],
            monthlyReports: []
        };

        let sheetsConnected = false;
        let accessToken = null;
        let gapi = null;

        // Load data from localStorage and Google Sheets
        function loadData() {
            const saved = localStorage.getItem('financialData');
            if (saved) {
                financialData = JSON.parse(saved);
                updateDisplay();
            }
            
            // Versuche auch von Google Sheets zu laden
            loadFromGoogleSheets();
        }

        // Save data to localStorage and Google Sheets
        function saveData() {
            localStorage.setItem('financialData', JSON.stringify(financialData));
            saveToGoogleSheets();
        }

        // Google Sheets Integration
        function isGoogleSheetsConfigured() {
            return GOOGLE_SHEETS_CONFIG.clientId !== '1234567890-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com' && 
                   GOOGLE_SHEETS_CONFIG.spreadsheetId !== 'DEINE_SHEET_ID_HIER' &&
                   GOOGLE_SHEETS_CONFIG.apiKey !== 'DEIN_GOOGLE_API_KEY_HIER';
        }

        async function initializeGoogleSheets() {
            if (!isGoogleSheetsConfigured()) {
                updateSyncStatus('error');
                showNotification('‚ùå Google Sheets nicht konfiguriert! Client-ID und Sheet-ID erforderlich!');
                return;
            }

            try {
                updateSyncStatus('syncing');
                showNotification('üîÑ Lade Google API...');
                
                // Lade Google API mit Timeout
                const apiLoadPromise = loadGoogleAPI();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Google API Timeout nach 10 Sekunden')), 10000)
                );
                
                await Promise.race([apiLoadPromise, timeoutPromise]);
                showNotification('‚úÖ Google API geladen! Initialisiere OAuth...');
                
                // Initialisiere OAuth2
                await initializeOAuth();
                showNotification('‚úÖ OAuth initialisiert! Teste Sheet-Verbindung...');
                
                // Teste Verbindung zu Google Sheets (nur Lesezugriff mit API Key)
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.spreadsheetId}?key=${GOOGLE_SHEETS_CONFIG.apiKey}`
                );

                if (response.ok) {
                    const sheetInfo = await response.json();
                    sheetsConnected = true;
                    updateSyncStatus('success');
                    showNotification(`‚úÖ Google Sheets "${sheetInfo.properties.title}" bereit! Klicke "Sync Now" f√ºr Schreibzugriff.`);
                    
                    // Lade existierende Daten falls vorhanden
                    await loadFromGoogleSheets();
                } else {
                    const errorData = await response.json();
                    throw new Error(`API Fehler: ${errorData.error?.message || response.status}`);
                }
            } catch (error) {
                console.error('Google Sheets Initialisierung fehlgeschlagen:', error);
                updateSyncStatus('error');
                sheetsConnected = false;
                
                if (error.message.includes('Timeout')) {
                    showNotification('‚ùå Google API Timeout! Internetverbindung pr√ºfen oder sp√§ter versuchen.');
                } else if (error.message.includes('403')) {
                    showNotification('‚ùå Google Sheets Zugriff verweigert! Pr√ºfe API-Key und Berechtigungen!');
                } else if (error.message.includes('404')) {
                    showNotification('‚ùå Google Sheet nicht gefunden! Pr√ºfe die Sheet-ID!');
                } else if (error.message.includes('Script')) {
                    showNotification('‚ùå Google API konnte nicht geladen werden! Internetverbindung pr√ºfen.');
                } else {
                    showNotification(`‚ùå Google Sheets Verbindung fehlgeschlagen: ${error.message}`);
                }
            }
        }

        async function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                if (window.gapi) {
                    gapi = window.gapi;
                    resolve(window.gapi);
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    window.gapi.load('client:auth2', {
                        callback: () => {
                            gapi = window.gapi;
                            resolve(gapi);
                        },
                        onerror: (error) => {
                            console.error('Google API Load Error:', error);
                            reject(new Error('Google API konnte nicht geladen werden'));
                        }
                    });
                };
                script.onerror = (error) => {
                    console.error('Script Load Error:', error);
                    reject(new Error('Google API Script konnte nicht geladen werden'));
                };
                document.head.appendChild(script);
            });
        }

        async function initializeOAuth() {
            if (!gapi) {
                throw new Error('Google API nicht geladen');
            }

            try {
                // Initialisiere Google API Client
                await gapi.client.init({
                    apiKey: GOOGLE_SHEETS_CONFIG.apiKey,
                    clientId: GOOGLE_SHEETS_CONFIG.clientId,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    scope: GOOGLE_SHEETS_CONFIG.scopes
                });

                // Initialisiere Auth2 falls noch nicht vorhanden
                if (!gapi.auth2.getAuthInstance()) {
                    await gapi.auth2.init({
                        client_id: GOOGLE_SHEETS_CONFIG.clientId,
                        scope: GOOGLE_SHEETS_CONFIG.scopes
                    });
                }
            } catch (error) {
                console.warn('OAuth2 Initialisierung fehlgeschlagen:', error);
                // Funktioniert trotzdem mit API-Key f√ºr Lesezugriff
            }
        }

        async function authenticateUser() {
            if (!gapi || !gapi.auth2) {
                throw new Error('Google API nicht verf√ºgbar');
            }

            const authInstance = gapi.auth2.getAuthInstance();
            if (!authInstance.isSignedIn.get()) {
                await authInstance.signIn();
            }

            const user = authInstance.currentUser.get();
            const authResponse = user.getAuthResponse();
            accessToken = authResponse.access_token;
            
            return accessToken;
        }

        async function setupSheetHeaders() {
            try {
                // Pr√ºfe ob bereits Daten vorhanden sind
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.spreadsheetId}/values/${GOOGLE_SHEETS_CONFIG.range}?key=${GOOGLE_SHEETS_CONFIG.apiKey}`
                );

                const data = await response.json();
                
                // Wenn Sheet leer ist, erstelle Header
                if (!data.values || data.values.length === 0) {
                    const headers = [
                        ['Timestamp', 'Typ', 'Kategorie', 'Beschreibung', 'Betrag', 'Monat', 'JSON_Data']
                    ];
                    
                    await updateSheetData(headers);
                    showNotification('Google Sheet wurde initialisiert! üìã');
                }
            } catch (error) {
                console.error('Header Setup Fehler:', error);
            }
        }

        async function saveToGoogleSheets() {
            if (!isGoogleSheetsConfigured()) {
                updateSyncStatus('error');
                showNotification('‚ùå Google Sheets Client-ID oder Sheet-ID fehlt!');
                return;
            }

            if (!sheetsConnected) {
                updateSyncStatus('error');
                showNotification('‚ùå Google Sheets nicht verbunden!');
                return;
            }

            try {
                updateSyncStatus('syncing');
                
                // Authentifiziere Benutzer f√ºr Schreibzugriff
                if (!accessToken) {
                    await authenticateUser();
                }
                
                // Strukturierte Daten f√ºr Google Sheets
                const sheetData = prepareDetailedSheetData();
                
                // Erst Sheet leeren, dann neue Daten schreiben
                await clearSheetWithAuth();
                await writeToSheetWithAuth(sheetData);
                
                updateSyncStatus('success');
                showNotification('‚úÖ Erfolgreich zu Google Sheets gespeichert!');
            } catch (error) {
                console.error('Google Sheets Speichern fehlgeschlagen:', error);
                updateSyncStatus('error');
                
                if (error.message.includes('authentication') || error.message.includes('OAuth')) {
                    showNotification('‚ùå Bitte melde dich bei Google an! Klicke "Sync Now" erneut.');
                    accessToken = null; // Reset token
                } else {
                    showNotification('‚ùå Google Sheets Fehler: ' + error.message);
                }
                throw error;
            }
        }

        function prepareDetailedSheetData() {
            const timestamp = new Date().toLocaleString('de-DE');
            const data = [];
            
            // Header
            data.push(['=== FINANZPLANER DATEN ===', timestamp]);
            data.push([]);
            
            // Einnahmen Sektion
            data.push(['EINNAHMEN']);
            data.push(['Haupteinkommen', financialData.mainIncome]);
            data.push(['Nebeneinkommen', financialData.sideIncome]);
            data.push(['Gesamt Einnahmen', financialData.mainIncome + financialData.sideIncome]);
            data.push([]);
            
            // Fixkosten Sektion
            data.push(['FIXKOSTEN']);
            data.push(['Bezeichnung', 'Betrag', 'Datum']);
            financialData.monthlyCosts.forEach(cost => {
                data.push([cost.name, cost.amount, formatDate(cost.date)]);
            });
            data.push(['Gesamt Fixkosten', financialData.monthlyCosts.reduce((sum, cost) => sum + cost.amount, 0)]);
            data.push([]);
            
            // Variable Ausgaben Sektion
            data.push(['VARIABLE AUSGABEN']);
            data.push(['Beschreibung', 'Betrag', 'Datum']);
            financialData.weeklyPurchases.forEach(purchase => {
                data.push([purchase.name, purchase.amount, formatDate(purchase.date)]);
            });
            data.push(['Gesamt Variable', financialData.weeklyPurchases.reduce((sum, purchase) => sum + purchase.amount, 0)]);
            data.push([]);
            
            // Monatsberichte Sektion
            if (financialData.monthlyReports.length > 0) {
                data.push(['MONATSBERICHTE']);
                data.push(['Monat', 'Einnahmen', 'Fixkosten', 'Variable', 'Saldo']);
                financialData.monthlyReports.forEach(report => {
                    data.push([
                        formatMonth(report.month),
                        report.income,
                        report.fixedCosts,
                        report.variableExpenses,
                        report.balance
                    ]);
                });
            }
            
            return data;
        }

        async function clearSheetWithAuth() {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.spreadsheetId}/values/A:Z:clear`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Sheet leeren fehlgeschlagen: ${errorData.error?.message || response.status}`);
            }
        }

        async function writeToSheetWithAuth(data) {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.spreadsheetId}/values/A1?valueInputOption=RAW`,
                {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        values: data
                    })
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Daten schreiben fehlgeschlagen: ${errorData.error?.message || response.status}`);
            }

            return await response.json();
        }

        // Fallback-Funktionen f√ºr API-Key (nur Lesezugriff)
        async function clearSheet() {
            throw new Error('Schreibzugriff erfordert OAuth2-Authentifizierung');
        }

        async function writeToSheet(data) {
            throw new Error('Schreibzugriff erfordert OAuth2-Authentifizierung');
        }

        function prepareSheetData() {
            const timestamp = new Date().toISOString();
            const sheetData = [
                ['Timestamp', 'Typ', 'Kategorie', 'Beschreibung', 'Betrag', 'Monat', 'JSON_Data']
            ];

            // Einnahmen
            if (financialData.mainIncome > 0) {
                sheetData.push([timestamp, 'Einnahme', 'Haupteinkommen', 'Haupteinkommen', financialData.mainIncome, new Date().toISOString().slice(0, 7), '']);
            }
            if (financialData.sideIncome > 0) {
                sheetData.push([timestamp, 'Einnahme', 'Nebeneinkommen', 'Nebeneinkommen', financialData.sideIncome, new Date().toISOString().slice(0, 7), '']);
            }

            // Fixkosten
            financialData.monthlyCosts.forEach(cost => {
                sheetData.push([
                    cost.date || timestamp,
                    'Fixkosten',
                    'Monatlich',
                    cost.name,
                    cost.amount,
                    new Date(cost.date || timestamp).toISOString().slice(0, 7),
                    ''
                ]);
            });

            // Variable Ausgaben
            financialData.weeklyPurchases.forEach(purchase => {
                sheetData.push([
                    purchase.date || timestamp,
                    'Variable Ausgabe',
                    'Einkauf',
                    purchase.name,
                    purchase.amount,
                    new Date(purchase.date || timestamp).toISOString().slice(0, 7),
                    ''
                ]);
            });

            // Monatsberichte
            financialData.monthlyReports.forEach(report => {
                sheetData.push([
                    report.date || timestamp,
                    'Monatsbericht',
                    'Zusammenfassung',
                    `Bericht ${formatMonth(report.month)}`,
                    report.balance,
                    report.month,
                    JSON.stringify(report)
                ]);
            });

            return sheetData;
        }

        async function updateSheetData(data) {
            try {
                // Verwende einfache Append-Methode statt Clear+Update
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.spreadsheetId}/values/A1:append?valueInputOption=RAW&insertDataOption=OVERWRITE&key=${GOOGLE_SHEETS_CONFIG.apiKey}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            values: data
                        })
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Google Sheets API Fehler:', errorData);
                    throw new Error(`API Fehler: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Detaillierter Fehler:', error);
                throw error;
            }
        }

        async function loadFromGoogleSheets() {
            if (!isGoogleSheetsConfigured()) {
                return;
            }

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.spreadsheetId}/values/${GOOGLE_SHEETS_CONFIG.range}?key=${GOOGLE_SHEETS_CONFIG.apiKey}`
                );

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.values && data.values.length > 1) {
                        // Verarbeite Sheet-Daten zur√ºck zu financialData
                        // (Vereinfachte Version - l√§dt nur wenn lokale Daten leer sind)
                        const localDataExists = localStorage.getItem('financialData');
                        if (!localDataExists) {
                            showNotification('Daten von Google Sheets geladen! üì•');
                        }
                    }
                }
            } catch (error) {
                console.error('Google Sheets Laden fehlgeschlagen:', error);
            }
        }

        function updateSyncStatus(status) {
            const statusElement = document.getElementById('syncStatus');
            switch(status) {
                case 'success':
                    statusElement.textContent = '‚úÖ Verbunden';
                    statusElement.className = 'px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full';
                    break;
                case 'error':
                    statusElement.textContent = '‚ùå Fehler';
                    statusElement.className = 'px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full';
                    break;
                case 'syncing':
                    statusElement.textContent = 'üîÑ Synchronisiert...';
                    statusElement.className = 'px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full';
                    break;
                case 'local':
                    statusElement.textContent = 'üíæ Lokal';
                    statusElement.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full';
                    break;
                default:
                    statusElement.textContent = '‚è≥ Bereit';
                    statusElement.className = 'px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full';
            }
        }

        // Manuelle Synchronisation
        async function manualSync() {
            if (!isGoogleSheetsConfigured()) {
                showNotification('‚ùå Google Sheets nicht konfiguriert! Client-ID und Sheet-ID erforderlich!');
                return;
            }

            if (!sheetsConnected) {
                showNotification('üîÑ Versuche Verbindung zu Google Sheets...');
                await initializeGoogleSheets();
                return;
            }

            try {
                // Zeige Login-Dialog falls n√∂tig
                if (!accessToken) {
                    showNotification('üîê Google Login wird ge√∂ffnet...');
                }
                
                await saveToGoogleSheets();
                showNotification('‚úÖ Manuelle Synchronisation erfolgreich!');
            } catch (error) {
                if (error.message.includes('popup') || error.message.includes('blocked')) {
                    showNotification('‚ùå Popup blockiert! Erlaube Popups f√ºr diese Seite.');
                } else {
                    showNotification('‚ùå Synchronisation fehlgeschlagen: ' + error.message);
                }
            }
        }

        // Excel Export Function
        function exportToExcel() {
            const data = prepareExportData();
            const csvContent = convertToCSV(data);
            downloadCSV(csvContent, `Finanzplaner_${new Date().toISOString().slice(0, 10)}.csv`);
            showNotification('Excel-Datei wurde heruntergeladen! üìÅ');
        }

        function prepareExportData() {
            const exportData = [];
            
            // Header
            exportData.push(['Finanzplaner Export - ' + new Date().toLocaleDateString('de-DE')]);
            exportData.push([]);
            
            // Einnahmen
            exportData.push(['EINNAHMEN']);
            exportData.push(['Haupteinkommen', formatCurrency(financialData.mainIncome)]);
            exportData.push(['Nebeneinkommen', formatCurrency(financialData.sideIncome)]);
            exportData.push(['Gesamt Einnahmen', formatCurrency(financialData.mainIncome + financialData.sideIncome)]);
            exportData.push([]);
            
            // Fixkosten
            exportData.push(['FIXKOSTEN']);
            financialData.monthlyCosts.forEach(cost => {
                exportData.push([cost.name, formatCurrency(cost.amount), formatDate(cost.date)]);
            });
            exportData.push(['Gesamt Fixkosten', formatCurrency(financialData.monthlyCosts.reduce((sum, cost) => sum + cost.amount, 0))]);
            exportData.push([]);
            
            // Variable Ausgaben
            exportData.push(['VARIABLE AUSGABEN']);
            financialData.weeklyPurchases.forEach(purchase => {
                exportData.push([purchase.name, formatCurrency(purchase.amount), formatDate(purchase.date)]);
            });
            exportData.push(['Gesamt Variable', formatCurrency(financialData.weeklyPurchases.reduce((sum, purchase) => sum + purchase.amount, 0))]);
            exportData.push([]);
            
            // Monatsberichte
            if (financialData.monthlyReports.length > 0) {
                exportData.push(['MONATSBERICHTE']);
                exportData.push(['Monat', 'Einnahmen', 'Fixkosten', 'Variable Ausgaben', 'Saldo']);
                financialData.monthlyReports.forEach(report => {
                    exportData.push([
                        formatMonth(report.month),
                        formatCurrency(report.income),
                        formatCurrency(report.fixedCosts),
                        formatCurrency(report.variableExpenses),
                        formatCurrency(report.balance)
                    ]);
                });
            }
            
            return exportData;
        }

        function convertToCSV(data) {
            return data.map(row => 
                row.map(cell => 
                    typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell
                ).join(',')
            ).join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Update income
        function updateIncome() {
            const mainIncome = parseFloat(document.getElementById('mainIncome').value) || 0;
            const sideIncome = parseFloat(document.getElementById('sideIncome').value) || 0;
            
            financialData.mainIncome = mainIncome;
            financialData.sideIncome = sideIncome;
            
            updateDisplay();
            saveData();
            showNotification('Einnahmen aktualisiert! üí∞');
        }

        // Add monthly cost
        function addMonthlyCost() {
            const name = document.getElementById('costName').value.trim();
            const amount = parseFloat(document.getElementById('costAmount').value) || 0;
            
            if (name && amount > 0) {
                financialData.monthlyCosts.push({
                    id: Date.now(),
                    name: name,
                    amount: amount,
                    date: new Date().toISOString()
                });
                
                document.getElementById('costName').value = '';
                document.getElementById('costAmount').value = '';
                
                updateDisplay();
                saveData();
                showNotification('Monatliche Kosten hinzugef√ºgt! üìã');
            }
        }

        // Remove monthly cost
        function removeMonthlyCost(id) {
            financialData.monthlyCosts = financialData.monthlyCosts.filter(cost => cost.id !== id);
            updateDisplay();
            saveData();
            showNotification('Kosten entfernt! üóëÔ∏è');
        }

        // Add purchase
        function addPurchase() {
            const name = document.getElementById('purchaseName').value.trim();
            const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
            
            if (name && amount > 0) {
                financialData.weeklyPurchases.push({
                    id: Date.now(),
                    name: name,
                    amount: amount,
                    date: new Date().toISOString()
                });
                
                document.getElementById('purchaseName').value = '';
                document.getElementById('purchaseAmount').value = '';
                
                updateDisplay();
                saveData();
                showNotification('Einkauf hinzugef√ºgt! üõí');
            }
        }

        // Remove purchase
        function removePurchase(id) {
            financialData.weeklyPurchases = financialData.weeklyPurchases.filter(purchase => purchase.id !== id);
            updateDisplay();
            saveData();
            showNotification('Einkauf entfernt! üóëÔ∏è');
        }

        // Update display
        function updateDisplay() {
            // Update summary
            const totalIncome = financialData.mainIncome + financialData.sideIncome;
            const totalMonthly = financialData.monthlyCosts.reduce((sum, cost) => sum + cost.amount, 0);
            const available = totalIncome - totalMonthly;
            
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalMonthly').textContent = formatCurrency(totalMonthly);
            document.getElementById('available').textContent = formatCurrency(available);
            
            // Update input fields
            document.getElementById('mainIncome').value = financialData.mainIncome || '';
            document.getElementById('sideIncome').value = financialData.sideIncome || '';
            
            // Update monthly costs list
            const monthlyCostsList = document.getElementById('monthlyCostsList');
            monthlyCostsList.innerHTML = '';
            financialData.monthlyCosts.forEach(cost => {
                const costElement = document.createElement('div');
                costElement.className = 'flex justify-between items-center p-4 bg-white rounded-xl border border-gray-100 fade-in';
                costElement.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-900">${cost.name}</span>
                        <span class="text-sm text-gray-500 block">${formatCurrency(cost.amount)}</span>
                    </div>
                    <button onclick="removeMonthlyCost(${cost.id})" 
                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">√ó</button>
                `;
                monthlyCostsList.appendChild(costElement);
            });
            
            // Update purchases list
            const weeklyTotal = financialData.weeklyPurchases.reduce((sum, purchase) => sum + purchase.amount, 0);
            document.getElementById('weeklyTotal').textContent = formatCurrency(weeklyTotal);
            
            const purchasesList = document.getElementById('purchasesList');
            purchasesList.innerHTML = '';
            financialData.weeklyPurchases.forEach(purchase => {
                const purchaseElement = document.createElement('div');
                purchaseElement.className = 'flex justify-between items-center p-4 bg-white rounded-xl border border-gray-100 fade-in';
                purchaseElement.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-900">${purchase.name}</span>
                        <span class="text-sm text-gray-500 block">${formatCurrency(purchase.amount)} ‚Ä¢ ${formatDate(purchase.date)}</span>
                    </div>
                    <button onclick="removePurchase(${purchase.id})" 
                            class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">√ó</button>
                `;
                purchasesList.appendChild(purchaseElement);
            });
        }

        // Generate monthly report
        function generateMonthlyReport() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            const totalIncome = financialData.mainIncome + financialData.sideIncome;
            const totalMonthly = financialData.monthlyCosts.reduce((sum, cost) => sum + cost.amount, 0);
            const totalWeekly = financialData.weeklyPurchases.reduce((sum, purchase) => sum + purchase.amount, 0);
            const saldo = totalIncome - totalMonthly - totalWeekly;
            
            const report = {
                month: currentMonth,
                income: totalIncome,
                fixedCosts: totalMonthly,
                variableExpenses: totalWeekly,
                balance: saldo,
                date: new Date().toISOString(),
                fixedCostsList: [...financialData.monthlyCosts]
            };
            
            // Add to reports if not already exists for this month
            const existingIndex = financialData.monthlyReports.findIndex(r => r.month === currentMonth);
            if (existingIndex >= 0) {
                financialData.monthlyReports[existingIndex] = report;
            } else {
                financialData.monthlyReports.push(report);
            }
            
            // Clear only weekly purchases for new month
            financialData.weeklyPurchases = [];
            
            updateDisplay();
            displayMonthlyReport();
            saveData();
            showNotification('Monatsbericht erstellt! Fixkosten wurden f√ºr n√§chsten Monat √ºbernommen üìä');
        }

        // Display monthly report
        function displayMonthlyReport() {
            const reportSection = document.getElementById('monthlyReport');
            const tableBody = document.getElementById('reportTableBody');
            
            tableBody.innerHTML = '';
            financialData.monthlyReports.forEach(report => {
                const row = document.createElement('tr');
                row.className = 'fade-in';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatMonth(report.month)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(report.income)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(report.fixedCosts)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatCurrency(report.variableExpenses)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${report.balance >= 0 ? 'text-indigo-600' : 'text-red-500'}">${formatCurrency(report.balance)}</td>
                `;
                tableBody.appendChild(row);
            });
            
            reportSection.classList.remove('hidden');
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('de-DE');
        }

        function formatMonth(monthString) {
            const date = new Date(monthString + '-01');
            return date.toLocaleDateString('de-DE', { year: 'numeric', month: 'long' });
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-6 right-6 bg-white border border-gray-200 text-gray-900 px-6 py-4 rounded-2xl shadow-lg z-50 fade-in';
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-indigo-500 rounded-full"></div>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
                setTimeout(() => notification.remove(), 200);
            }, 3000);
        }

        // Auto-sync on 24th of month
        function checkAutoSync() {
            const today = new Date();
            if (today.getDate() === 24) {
                generateMonthlyReport();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initializeGoogleSheets();
            
            // Add enter key listeners
            document.getElementById('costName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addMonthlyCost();
            });
            
            document.getElementById('costAmount').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addMonthlyCost();
            });
            
            document.getElementById('purchaseName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addPurchase();
            });
            
            document.getElementById('purchaseAmount').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addPurchase();
            });
            
            // Check for auto-sync daily
            setInterval(checkAutoSync, 24 * 60 * 60 * 1000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974a301433a5dbc1',t:'MTc1NjExNTQ1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
